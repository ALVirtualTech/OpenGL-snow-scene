% -*- compile-command: "pdflatex report.tex"; -*-
\documentclass[a4paper,12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{hyperref}
\lstset{
language=C,
basicstyle=\footnotesize
}

\title{Let it snow}
\author{Christian Luckey \\ Matteus Hemstr√∂m}


\begin{document}

\maketitle

\newpage

\section{Introduction}

We set out with one simple task: We wanted to make it snow with real time graphics. We wanted to create a real time world looking like Figure~\ref{fig:youtube}:

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.9\textwidth]{youtube}
  \caption{\label{fig:youtube} Source: \href{https://www.youtube.com/watch?v=vHZb2xdVTCA}{https://www.youtube.com/watch?v=vHZb2xdVTCA}}
\end{figure}
\noindent
And off we went!



\section{Background}

In Figure~\ref{fig:youtube} and associated video we can identify a couple of elements being present:

\begin{enumerate}
  \item Models for trees and light posts.
  \item Multiple directed light cones.
  \item Snow on the ground.
  \item Snow tumbling through the air.
  \item Shadows cast on the ground.
  \item Snow stuck and falling on the camera lens.
  \item The camera shaking.
\end{enumerate}

All these has some crux, even the most simplest tasks like placing millions of little snow flakes on the screen. Lets look at them in order.


\subsection{Multiple directed light cones}

We looked into a couple of different techniques when it came to making the light:


\subsection{Snow on the ground}

There were some pretty sophisticated models used in the Disney film Frozen \href{https://disney-animation.s3.amazonaws.com/uploads/production/publication_asset/94/asset/SSCTS13_2.pdf}{[1]}, but we deemed them unfit for real time usage. Then again the reference image has no moving ground snow.


\subsection{Shadows}


\subsubsection{Shadow stensils}

\subsubsection{Shadow Maps}

Shadow maps are achieved by rendering the scene from the viewport of the light source.


\subsection{Falling snow}

\subsubsection{Navier Stokes}

In order to simulate the effect of gusts of wind blowing on the snow navier stokes equations could be used \href{http://www.intpowertechcorp.com/GDC03.pdf}{[2]}. The linked paper is about fluid dynamics but since they're pretty much the same we're sure the methods described could still be applied.




\section{Implementation}

With 3200 fresh lines of code our solution is split up into 10 C files and 10 shader programs. We do geometry instancing for the particle systems, shadow maps for the projection of shadows and proximity based directed lighting.


\subsection{Shadow maps}

Something which eased our work was the realization that a camera and a light source have a lot of commonalities:

\begin{lstlisting}[float,label=lst:lamp-struct,caption=nextHopInfo: Light source struct]
struct Camera {
	vec3 position;
	vec3 normal;
	vec3 target;
	mat4 projection;
};

struct Light {
	struct Camera camera;
	vec3 intensities;
	float ambientCoefficient;
	float coneAngle;
};
\end{lstlisting}

This made it possible for us to position and rotate the light sources using the normal FPS camera controls we had developed for the camera - merely storing the data kept in a camera and then using it for a light source.

Other than that there is nothing surprising in our implementation of shadow maps. We draw the the depth map with the simplest shader possible after which we use the resulting FBO.


\section{Problems}

A lot, like you have no idea how many problems we had.

\subsection{Detangling global state}

We've probably refactored the codebase completelely somewhere around three times, trying to untangle it from iself. The code we started out with, mostly based on old lab and project code with

\subsection{Shadow buffer bugs}

We ended up wasting about a week trying to debug a fully working implementation of shadow maps, only that it didn't render correct on the specific hardware we were developing it on.


\section{Conclusions}

What we got was this:

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.9\textwidth]{result}
  \caption{\label{fig:label} Our OpenGL snow scene.}
\end{figure}

You can also see a short video on \href{YouTube}{TODO!}

\end{document}